# *	æŠ€æœ¯æ¶æ„*

vue+django+restframework+uwsgi+nginx+docker

# è™šæ‹Ÿç¯å¢ƒæ­å»º

# æ•°æ®åº“è¿æ¥

# æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

`create database dailyfresh charset=utf8;   åˆ›å»ºutf-8ç¼–ç çš„æ•°æ®åº“`

## *ç”¨æˆ·è¡¨*

## *æ”¶è´§ä¿¡æ¯è¡¨*

## *å•†å“*

## *è®¢å•*

### *è®¢å•ä¿¡æ¯*

```python
æ”¶ä»¶åœ°å€
æ”¯ä»˜æ–¹å¼
è®¢å•å·
ç”¨æˆ· :fk
å•†å“æ•°é‡
å•†å“æ€»ä»·
è¿è´¹
è®¢å•çŠ¶æ€
æ”¯ä»˜ç¼–å·
```

### *è®¢å•å•†å“*

```python
è®¢å•:fk
å•†å“
å•†å“æ•°é‡
ä»·æ ¼
è¯„è®º
```



# *api*

## *User*

### *æ³¨å†Œ*

- `æ³¨å†Œ`

  - `ç¡®è®¤å¯†ç å’Œå¯†ç é¡»ä¸€è‡´`

- `ç”Ÿæˆtoken`

  ```python
  import os,sys
  sys.path.append("/Users/songyi/PycharmProjects/dailyfresh/")
  os.environ.setdefault("DJANGO_SETTINGS_MODULE", "dailyfresh.settings")
  
  from itsdangerous import  TimedJSONWebSignatureSerializer as Sign
  from django.conf import settings
  
  
  class Token(object):
      serializer = Sign(settings.SECRET_KEY, 300)
      __first = None
  
      def __new__(cls, *args, **kwargs):
          "ä½¿ç”¨å•ä¾‹æ¨¡å¼åˆ›é€ åŠ è§£å¯†å¯¹è±¡"
          if not Token.__first:
              Token.__first = object.__new__(cls)
          return Token.__first
  
      def encryt(self,text):
          info = {"key":text}
          res = self.serializer.dumps(info)
          return res
  
      def decryt(self,params):
          try:
              res = self.serializer.loads(params)
              return res
          except Exception as e:
              pass
  
  ```

- `æ¥å£è¿”å›æ•°æ®æ ¼å¼`

  ```
  å…³äºè¯¥ç”¨æˆ·ä¸ªäººä¿¡æ¯ + è®¢å•ä¿¡æ¯
  index
  ```

### *celeryå‘é€é‚®ä»¶*

```python
#djangoé»˜è®¤é‚®ä»¶å‘é€é…ç½®
from django.core.mail import send_mail
import os,sys

sys.path.append("/Users/songyi/PycharmProjects/dailyfresh/")
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "dailyfresh.settings")
app = Celery('tasks',broker='redis://192.168.1.6:6379/8')


@app.task
def send_QQmail(subject,msg,sender,reciver,content):
    try:
        send_mail(
            subject = subject,
            message = msg,
            from_email = sender,
            recipient_list = [reciver],
            html_message = content,
            fail_silently = True
        )
    except Exception as e:
        pass
```

### *æ¿€æ´»*

- é—®é¢˜

  ```python
  - æ˜¯å¦åº”è¯¥é™åˆ¶æŸä¸€ipçš„è¯·æ±‚æ¬¡æ•°ï¼Ÿ
  - å¤§é‡æ¿€æ´»è¯·æ±‚?
  
  ```

- `å€Ÿå£å‘é€æ•°æ®æ ¼å¼Â·`

  ```python
  {
    "token":,
  }
  ```

  

- `æ¥å£è¿”å›æ•°æ®æ ¼å¼`

  ```python
  {
    "user_info":{
      
    },
    "redirect_url":,
    
    
  }
  ```

  

### *ç™»å½•*

#### *session*

##### *å‰ç«¯*

##### *API*

###### *ç™»å½•å‚æ•°*

```python
username:
password:
remember:T/F 
```



###### *djangoç¼“å­˜å’Œsessioné…ç½®*

```python
# Djangoçš„ç¼“å­˜é…ç½®(ä½¿ç”¨redisä½œä¸ºç¼“å­˜)
CACHES = {
    "default": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://192.168.1.6:6379/9",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    }
}

# é…ç½®sessionå­˜å‚¨åœ¨ç¼“å­˜ä¸­
SESSION_ENGINE = "django.contrib.sessions.backends.cache"
SESSION_CACHE_ALIAS = "default"
```



###### *ä¸­é—´ä»¶æ£€éªŒ session*

```python
from django.utils.deprecation import MiddlewareMixin
from django.conf import settings

class SessionCheckMiddleware(MiddlewareMixin):

    def process_view(self, request, view_func, view_args, view_kwargs):
        """ä¸­é—´ä»¶å±€éƒ¨ä½¿ç”¨æ€è·¯"""
        # è·å–å‡½æ•°å®Œæ•´è·¯å¾„
        view_name = '.'.join((view_func.__module__, view_func.__name__))
        # settingsè®¾ç½®ç™½åå•
        exclusion_set = getattr(settings, 'EXCLUDE_FROM_MY_MIDDLEWARE', set())
        #å¦‚æœåœ¨ç™½åå•å†…åˆ™éœ€è¦ä¸éœ€è¦æ£€æµ‹cookie
        if view_name in exclusion_set: return None
        
				"""æ£€æµ‹session,å¹¶å­˜å…¥requestå¯¹è±¡ä¸­ä»¥ä¾¿åé¢ä½¿ç”¨"""
        session_id = request.COOKIES.get("sessionid")
        # å¦‚æœè·å–ä¸åˆ°sessionid or ä¸å­˜åœ¨ åˆ™éœ€è¦ç»è¿‡mysqlæŸ¥è¯¢
        if not session_id or not request.session.exists(session_id):
          if view_name != "apps.user.views.LoginView": 
            
          request.user_obj = None
        else:
            #sessionä¸­å–å‡ºç”¨æˆ·ä¿¡æ¯å­˜åˆ°requestå¯¹è±¡ä¸­
            request.user_obj = request.session.get("user")
            #è®¢å•ä¿¡æ¯
            #æµè§ˆè®°å½•
            # ...
```

###### *è§†å›¾*

```python
class LoginView(APIView):
    """
    ç”¨æˆ·ç™»å½•
    """
    def verify_account(self,request):
        """ç¬¬ä¸€æ¬¡ or seesionid è¿‡æœŸ æ—¶å€™éœ€è¦æ•°æ®åº“æŸ¥è¯¢"""

    def create_session(self,user,request):
        request.session.flush()
        #å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥session
        # request.session["user_info"] = pickle.dumps(model_to_dict(user,exclude=[""]))
        
        #å°†ç”¨æˆ·çš„å„ç§ä¿¡æ¯å­˜å…¥sessionä¸­
        request.session["user"] = user
        #ç”¨æˆ·è®¢å•ä¿¡æ¯
        #...

    def set_cookie(self,request,user):
        ..

    def post(self,request):
      	#sessioné”™è¯¯ or ä¸å­˜åœ¨
        if not request.user_obj:
            user = self.verify_account(request)
            if not user:
                return Response({
                    "code":"",
                    "error": "ç™»å½•å¤±è´¥",
                    "redirect_url": ""})
        #sessionæœªè¿‡æœŸ      
        else:
            user = request.user_obj
				#é‡ç½®session
        self.create_session(user,request)

        return self.set_cookie(request,user)
```

#### *Jwtç™»å½•*

- ...

#### *Restframeworkè®¤è¯ç»„ä»¶*

`âš ï¸ : CSRF token missing`

```python
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework.authentication.TokenAuthentication',
     		#æ­¤å¤„éœ€è¦å»æ‰SessionAuthenticationï¼Œ
      	#å¦‚æœæºå¸¦cookieè®¿é—®,SessionAuthentication é»˜è®¤ä¼šè§¦å‘ csrféªŒè¯
    ) 
}
```

##### *djangoå†…ç½®authè®¤è¯*

`âš ï¸ : é»˜è®¤authæŒ‡å®šçš„userè¡¨ä¸å­˜å‚¨æ˜æ–‡,authenticateæ–¹æ³•æ˜¯å°†å®¢æˆ·ç«¯pwdğŸ”åå’Œæ•°æ®åº“æ¯”å¯¹`

- `ç™»å½•éªŒè¯`

  ```python
   user = authenticate(request,username=username, password=password)
   login(request,user)#ç™»å½•æˆåŠŸé»˜è®¤ä¿å­˜session
  ```

### *ç”¨æˆ·ä¸­å¿ƒ*

#### *æ”¶è´§åœ°å€*

- `View`

  ```python
  class AddressView(ListCreateAPIView):
      "ç”¨æˆ·åœ°å€,æ­¤apiæ¥å—ä¸¤ç§è¯·æ±‚"
      queryset = models.Address.objects
      filter_backends = [AddressFilter,]
  
      def get_dafault(self):
          "æ£€æµ‹æ˜¯å¦å«æœ‰é»˜è®¤åœ°å€"
      def get_serializer_class(self):
          #å› ä¸ºgetå’Œpostä¸¤ç§æ–¹æ³•çš„åºåˆ—åŒ–å™¨ä¸ä¸€æ ·,é€šè¿‡è¯·æ±‚æ–¹æ³•å®šåˆ¶åºåˆ—åŒ–å™¨
  				self.request._request.method
          
      def perform_create(self, serializer):
        #ä¿å­˜å‰æ£€æµ‹è¯¥ç”¨æˆ·æ˜¯å¦æœ‰é»˜è®¤åœ°å€ï¼Œæœ‰åˆ™ is_default = F
        serializer.save(user=self.request.user_obj,is_default=self.get_dafault())
  ```

- `Filter`

  ```python
  from rest_framework.filters import BaseFilterBackend
  
  class AddressFilter(BaseFilterBackend):
      def filter_queryset(self, request, queryset, view):
          user = request.user_obj
          result = queryset.filter(user=user,is_default=True)
          if result:
              return result
  ```

- `åºåˆ—åŒ–`

  - `get`

  - `Post`

    ```python
    class AddressPostSerializer(serializers.ModelSerializer):
        receiver = serializers.CharField(label="æ¥æ”¶è€…",max_length=20)
        addr = serializers.CharField(label="æ”¶ä»¶ä¿¡æ¯",max_length=256)
        code = serializers.CharField(label="é‚®ç¼–",max_length=6,allow_null=True)
        phone = serializers.CharField(label="ç”µè¯",max_length=11)#åœ¨å®šåˆ¶çš„åºåˆ—åŒ–å™¨è®¾å®šçº¦æŸæ¡ä»¶é¿å…ç¨‹åºerro
    
        def phone_verify(self,phone):
            regex = r"(1[3,4,5,6,7,8,9]\d{9})"
            if not re.match(regex,phone):
                raise ValidationError("æ ¼å¼é”™è¯¯")
    
        def validated_phone(self,phone):
            return self.phone_verify(phone)
    
        class Meta:
            model = Address
            fields = ["receiver","addr","code","phone"]
    ```

  *å®šåˆ¶é»˜è®¤åœ°å€è®¾ç½®*

#### *ä¸ªäººä¿¡æ¯*

##### *æµè§ˆè®°å½•*

- `å‰ç«¯æ ¹æ®ç”¨æˆ·id åœ¨redisä¸­è·å– æµè§ˆè®°å½•`

#### *å…¨éƒ¨è®¢å•*

- `è®¢å•ä¿¡æ¯`
- `æ”¯ä»˜`
- `æŸ¥çœ‹ç‰©æµ`

### *æ›´æ–°å†å²è®°å½•æ¥å£*

- `ç”¨æˆ·æ¯è®¿é—®ä¸€æ¬¡å•†å“è¯¦æƒ…é¡µé¢,redisæ·»åŠ ä¸€æ¡å†å²è®°å½•`
- `æœ€å¤šå­˜å‚¨5æ¡`
- `æ•°æ®ç»“æ„`
  - `æ ˆï¼šå…ˆè¿›åå‡º`
  - `æ·»åŠ æ ¼å¼ "history_<user_id> = ['goods_id',..... ]"`
- `æµç¨‹`
  - `å…ˆæŸ¥è¯¢æ˜¯å¦å­˜åœ¨è¯¥key`
    - `1`
      - `goods_idæ˜¯å¦å­˜åœ¨åˆ—è¡¨ä¸­ï¼Ÿ`
        - `1`
          - `åˆ é™¤åˆ—è¡¨ä¸­çš„goods_id`
          - `ä»åˆ—è¡¨å¤´éƒ¨åŠ å…¥è¯¥goods_id`
    - `0`
      - `åˆ›å»ºkeyå¹¶æ·»åŠ å…ƒç´ `
  - `è¿”å›åˆ—è¡¨`
- `query_params`
  - `goods_id`

- `Api`
  - `user`
  - `history`





## *Goods*

### *indexæ•°æ®æ¥å£*

- `Api`

  ```python
  {
     'user' : { 		#è‹¥useræœªç™»å½•åˆ™valueä¸ºNone
          id : ,
          name : ,
          cart_count: ,
      },
      "type":{
          "id":,
          "name":,
          "goods_list":[
              ...
          ]
      }
  }
  ```

  


### *å•†å“åˆ—è¡¨*

- `query_params`

  ```python
  type_id:
  ```

- `Api`

  ```python
  {
      'user' : { 		#è‹¥useræœªç™»å½•åˆ™valueä¸ºNone
          id : ,
          name : ,
          cart_count: ,
      },
      'goods_info':[
        	{
            sku_id:'è·³è½¬å•†å“è¯¦æƒ…é¡µç”¨',
            name:,
            price:,
            å•ä½:,         
        }, ....]
   	'new_product':['æ ¹æ®create_timeè¿”å›æœ€è¿‘çš„æœ¬åˆ†ç±»ä¸­æœ€æ–°åˆ›å»ºçš„ä¸¤ä¸ªå•†å“']     
  }
  ```

### *å•†å“è¯¦æƒ…é¡µé¢*

- `query_params`

  - `goods_id`

- `Api`

  ```python
  """
  éœ€è¦æŸ¥è¯¢å•†å“æ˜¯å¦å­˜åœ¨/
  å•†å“çŠ¶æ€ ?
  è·å–å•å“ä¿¡æ¯:
      sku: sku_id/name/price/å•ä½/count/æè¿°
      åŒspuå…¶ä»–äº§å“: id/name
      spu: spu_id/name/å•†å“ä»‹ç»/
      æ–°å“æ¨è(2): è¯¥å•†å“ç±»å‹ä¸‹æ¨èå…¶ä»–å•å“
      cart_count:
      type:[
          {id:,name:,}
      ]
  é¡µé¢å…¶ä»–æ¥å£:
      1.add_cart
      2.buy
      3.comment
  å¾…å•†æ¦·:
      1.å•†å“çŠ¶æ€
      2.buy
      3.comment
  """
  ```

  

## *Order*

### *æ”¯ä»˜é¡µé¢*

- ç”¨æˆ·æ”¶è´§åœ°å€
- è®¢å•

- ç¼–è¾‘æ”¶è´§åœ°å€
- æ”¯ä»˜æ¥å£

### *ç”Ÿæˆè®¢å•æ¥å£*

- mysqläº‹åŠ¡

- è®¢å•çš„å¹¶å‘

  - `ä¹è§‚é”å¤„ç†æœºåˆ¶`

    ```python
    'å‡è®¾ç”¨ä¸‰ç»„ç”¨æˆ·åŒæ—¶ç§’æ€ Mac_pro(åº“å­˜3) A/B/C
    A B C åŒæ—¶åˆ›å»ºè®¢å•
    ç”±äºcpuä¼šä¸æ–­åˆ‡æ¢çº¿ç¨‹æ¥æ‰§è¡Œ
    Aç”¨æˆ· ä»å¼€å§‹-ä¿å­˜æ•°æ®ä¹‹å‰è¡¨ä¸­çš„åº“å­˜æ²¡æœ‰å˜åŒ–,Aç”¨æˆ·ä¸‹å•SUCï¼Œæ­¤æ—¶åº“å­˜ä¸º2
    bç”¨æˆ·ç«äº‰åˆ°GILé”å¹¶æ‰§è¡Œä»£ç ,ä½†æ˜¯å¹¶æœªåœ¨CPUå…è®¸çš„æ—¶é—´å†…å®Œæˆä»£ç ,äº¤å‡ºGILé”,ç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œï¼Œæ­¤æ—¶åº“å­˜ä¸º2
    cç”¨æˆ·ç«äº‰åˆ°GILé”ï¼Œå¹¶åœ¨è§„å®šæ—¶é—´å†…åˆ›å»ºå®Œæˆè®¢å•,æ­¤æ—¶åº“å­˜ä¸º1
    bç”¨æˆ·ç«äº‰åˆ°GIL,æ¥ç€ä¸Šä¸€æ¬¡çš„ä½ç½®æ‰§è¡Œä»£ç ,è¿™æ¬¡æ‰§è¡Œåˆ°ä¿å­˜æ•°æ®å‰å¾—åˆ°çš„åº“å­˜ä¸º1,æ£€æµ‹åˆ°åº“å­˜å‘ç”Ÿå˜åŒ–,ä¸­æ­¢ä¸‹é¢ä»£ç ,å¹¶ä»å¤´ç»§ç»­æ‰§è¡Œè¯¥ä»£ç 
    
    
    'æ— è®ºæ˜¯å†CPUç»™å®šçš„æ—¶é—´å†…å®Œæˆåˆ›å»ºä¸å¦ï¼Ÿåªè¦ä»£ç å¼€å¤´çš„åº“å­˜ å’Œ ä¿å­˜æ—¶å€™çš„åº“å­˜ä¸€è‡´,è¯´æ˜å…¶ä»–ç”¨æˆ·å¹¶æœªæ‰§è¡Œåˆ›å»ºè®¢å•æˆåŠŸ,åä¹‹åˆ™æ˜¯å…¶ä»–ç”¨æˆ·åˆ›å»ºæˆåŠŸå¹¶ä¸”æ›´æ–°äº†åº“å­˜'
    ```

  

  


### *æ”¯ä»˜æ¥å£*

### *è¯„è®ºæ¥å£*



















## *Cart*

### *è¯»å–ç”¨æˆ·è´­ç‰©è½¦æ¥å£*

- ç”¨æˆ·è®¢å•ä¿¡æ¯

### *åŠ å…¥è´­ç‰©è½¦æ¥å£*

- `rediså­˜å‚¨`

  ```python
  #é‡‡ç”¨å“ˆå¸Œå­˜å‚¨,å¯¹åŒä¸€å•†å“å åŠ ä½¿ç”¨ hincrbyæ–¹æ³•
  'cart_<user_id>': {
      'goods_id': count,
  }
  
  ```

- `form_data(post)`

  - `goods_id`
  - `count`

- `Api`

  ```PYTHON
  {
      'code':,
      "msg":,
      "data":{
          "user":'which ç”¨æˆ·',
          "goods":'æ·»åŠ çš„å•†å“id',
          "count":"æ·»åŠ çš„æ•°é‡"
      }
  }
  ```

# *é¡¹ç›®éƒ¨ç½²*








```pyton
2.serialzierä¼ å…¥å¯¹è±¡çš„è¿œå— 
3.Django os.environ.setdefault 
4.é¡µé¢å¦‚ä½•å‘é€ patchè¯·æ±‚ 
5.restframeworkçš„response ä¸ºä½•åªåœ¨update æœ‰æ•ˆï¼Ÿ
5modelseriliz å’Œseriliazçš„åŒºåˆ«


restframeworkçš„ Responseæ˜¯åºåˆ—åŒ–å¥½çš„,ç›´æ¥ç©¿å­—å…¸å°±è¡Œ
vueå‰ç«¯ + jenkins(ci/cd)è‡ªåŠ¨åŒ–éƒ¨ç½² + github + docker
```



